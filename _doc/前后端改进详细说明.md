# 前后端改进详细说明

## 1. 参数配置
### 1.1 存在问题
* 修改前后端都需要的配置项，需要注意前后端 **两个地方** 的配置项，而且需要 **对应** 起来。
* 有些常用的配置项直接写在前端代码或者后端代码里面，需要开发者侵入代码修改。

### 1.2 修改方案
* 前后端的配置统一写在后端，编辑器实例化时，异步读取后端配置信息，覆盖到前端的配置里。
* 把散落在代码里的常用配置项，提出来放到后端配置里。

### 1.3 修改收益

	对前后端通信的配置，开发者只需要关注后端一个文件。


## 2. 统一请求格式
### 2.1 存在问题
* 不同请求发送给不同的文件，请求的数据格式不规范
* 多个功能的返回值不一致，不便于管理代码和二次开发

现有各通信的返回值:
* 上传图片/上传附件/上传视频/word文档图片转存/拖放/粘贴板上传/截图工具上传
```
{'url':'upload/demo.jpg','title':'demo.jpg','original':'demo.jpg','state':'SUCCESS'}
```
* 涂鸦上传(添加背景)
```
<script>parent.ue_callback('upload/demo.jpg','SUCCESS')</script>
```
* 涂鸦上传(上传涂鸦完成后的base64图片)
```
{'url':'upload/demo.jpg',state:'SUCCESS'}
```
* 在线图片管理
```
upload/1.jpgue_separate_ueupload/2.jpg
```
* 远程图片
```
{'url':'upload/1.jpgue_separate_ueupload/2.jpg','tip':'远程图片抓取成功！','srcUrl':'http://img.baidu.com/1.jpgue_separate_uehttp://img.baidu.com/2.jpg'}
```


### 3.2 修改方案
* 通过唯一的后台文件```controller.php```处理前端的请求
* ```controller.php```通过GET上的action参数，判断是什么类型的请求
* 省去不必要的请求，去除涂鸦添加背景的请求，用前端FileReader读取本地图片代替
* 请求返回数据的格式，常规返回json字符串，数据包含state属性（成功时返回'SUCCESS'，错误时返回错误信息）。
* 请求支持jsonp请求格式，当请求有通过GET方式传callback的参数时，返回json数据前后加上括号，再在前面加上callback的值，格式类似这样：```cb({"key": "value"})```

### 3.3 格式规范
#### 3.2.1 getconfig
请求参数:
```
GET {"action": "getconfig"}
POST "upfile": File Data
```
返回格式:
```javascript
// 需要支持callback参数,返回jsonp格式
{
	"imageUrl": "http://localhost/ueditor/php/server.php?action=uploadimage",
	"imagePath": "/ueditor/php/",
	"imageFieldName": "upfile",
	"imageMaxSize": 2048,
	"imageAllowFiles": [".png", ".jpg", ".jpeg", ".gif", ".bmp"]
}
```

#### 3.2.1 uploadimage
请求参数:
```
GET {"action": "uploadimage"}
POST "upfile": File Data
```
返回格式:
```javascript
{
	"state": "SUCCESS",
    "url": "upload/demo.jpg",
	"title": "demo.jpg",
	"original": "demo.jpg"
}
```

#### 3.2.1 uploadscrawl
请求参数:
```
GET {"action": "uploadscrawl"}
POST "content": Base64 Data
```
返回格式:
```javascript
{
	"state": "SUCCESS",
    "url": "upload/demo.jpg",
	"title": "demo.jpg",
	"original": "demo.jpg"
}
```
#### 3.2.1 uploadvideo
请求参数:
```
GET {"action": "uploadvideo"}
POST "upfile": File Data
```
返回格式:
```javascript
{
	"state": "SUCCESS",
    "url": "upload/demo.mp4",
	"title": "demo.mp4",
	"original": "demo.mp4"
}
```

#### 3.2.1 uploadfile
请求参数:
```
GET {"action": "uploadfile"}
POST "upfile": File Data
```
返回格式:
```javascript
{
	"state": "SUCCESS",
    "url": "upload/demo.zip",
	"title": "demo.zip",
	"original": "demo.zip"
}
```

#### 3.2.1 listimage
请求参数:
```
GET {"action": "listimage", "start": 0, "size": 20}
```
返回格式:
```javascript
// 需要支持callback参数,返回jsonp格式
{
    "state": "SUCCESS",
    "list": [
        {"url": "upload/1.jpg"},
        {"url": "upload/2.jpg"},
    ],
    "start": 20,
    "total": 100
}
```

#### 3.2.1 catchimage
请求参数:
```
GET {
    "action": "catchimage",
     "source": [
     	"http://a.com/1.jpg",
        "http://a.com/2.jpg"
    ]
}
```
返回格式:
```javascript
// 需要支持callback参数,返回jsonp格式
// list项的state属性
{
    "state": "SUCCESS",
    "list": [
        {
        	"url": "upload/1.jpg",
        	"source": "http://b.com/2.jpg",
        	"state": "SUCCESS"
        }, {
        	"url": "upload/2.jpg",
        	"source": "http://b.com/2.jpg",
        	"state": "SUCCESS"
        },
    ]
}
```


## 4. 格式化上传文件名

之前已完成了文件名自定义格式化的功能，由于安全性问题和乱码的问题，暂时没上线功能。现在配置项放到后台比较安全，并且上传工具试用webuploader，编码可控，各版本的语言编码问题测试通过，就可以正式上线这个功能。

附上之前的文档：[链接](http://fex.baidu.com/ueditor/#use-format_upload_filename)

## 5. 兼容旧版本

原有ueditor.config.js可以保留使用
